<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>3</storyId>
    <title>Configure Vitest for Testing</title>
    <status>drafted</status>
    <generatedAt>2025-11-03</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/1-3-configure-vitest-for-testing.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>Vitest configured for running tests</iWant>
    <soThat>I can write and execute tests for all components</soThat>
    <tasks>
      <task id="1" ac="1,2,3,4">
        <description>Create vitest.config.ts configuration file</description>
        <subtasks>
          <subtask>Set test environment to 'node'</subtask>
          <subtask>Configure v8 coverage provider</subtask>
          <subtask>Add text, json, html coverage reporters</subtask>
          <subtask>Enable globals for test functions</subtask>
        </subtasks>
      </task>
      <task id="2" ac="5,6">
        <description>Verify Vitest commands work</description>
        <subtasks>
          <subtask>Test `bun test` command execution</subtask>
          <subtask>Test `bun test --coverage` coverage generation</subtask>
          <subtask>Verify coverage reports are generated in correct format</subtask>
        </subtasks>
      </task>
      <task id="3" ac="5,6">
        <description>Ensure npm scripts compatibility</description>
        <subtasks>
          <subtask>Verify existing "test" script in package.json works with Vitest</subtask>
          <subtask>Verify "test:coverage" script generates coverage reports</subtask>
        </subtasks>
      </task>
      <task id="4" ac="">
        <description>Create sample test to verify configuration</description>
        <subtasks>
          <subtask>Write basic test file to validate Vitest setup</subtask>
          <subtask>Confirm test discovery and execution</subtask>
          <subtask>Validate coverage report generation</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">vitest.config.ts created per architecture template</criterion>
    <criterion id="2">Test environment set to 'node'</criterion>
    <criterion id="3">Coverage provider set to 'v8'</criterion>
    <criterion id="4">Coverage reporters include text, json, html</criterion>
    <criterion id="5">`bun test` command executes Vitest</criterion>
    <criterion id="6">`bun test --coverage` generates coverage reports</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>ADR-005: Vitest over Jest</section>
        <snippet>Use Vitest 4.0 instead of Jest. 10x faster test execution than Jest, native ESM support (Jest has issues), better TypeScript integration, browser mode for integration tests, growing adoption in 2025 ecosystem.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Development Environment Setup (lines 1056-1070)</section>
        <snippet>vitest.config.ts template: defineConfig with test.globals=true, test.environment='node', test.coverage with provider='v8' and reporters=['text','json','html'].</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>NFR-4: Maintainability (line 152)</section>
        <snippet>Test coverage target: 70%+ coverage. Vitest for testing, Biome for code quality. Epic 7 focused on comprehensive test suite to meet this target.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Epic 1: Story 1.3</section>
        <snippet>Configure Vitest for testing. vitest.config.ts created per architecture template, test environment set to 'node', coverage provider set to 'v8', coverage reporters include text, json, html, bun test commands work.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>package.json</path>
        <kind>configuration</kind>
        <symbol>package manifest</symbol>
        <lines>1-29</lines>
        <reason>Contains vitest@4.0 in devDependencies. Has existing "test" and "test:coverage" scripts that need to work with Vitest configuration.</reason>
      </artifact>
      <artifact>
        <path>tsconfig.json</path>
        <kind>configuration</kind>
        <symbol>TypeScript configuration</symbol>
        <lines>1-15</lines>
        <reason>TypeScript configuration with strict mode. Vitest must integrate with TypeScript configuration for type-safe testing.</reason>
      </artifact>
      <artifact>
        <path>package.test.ts</path>
        <kind>test</kind>
        <symbol>dependency tests</symbol>
        <lines>1-74</lines>
        <reason>Existing test file with 12 tests. Must continue working after Vitest configuration is added. Example of test pattern to follow.</reason>
      </artifact>
      <artifact>
        <path>biome.config.test.ts</path>
        <kind>test</kind>
        <symbol>configuration tests</symbol>
        <lines>1-134</lines>
        <reason>Comprehensive configuration testing pattern (19 tests). Follow same approach for vitest.config.ts testing - test file existence, structure, all settings.</reason>
      </artifact>
    </code>
    <dependencies>
      <ecosystem name="Node.js/Bun">
        <current>
          <package name="vitest" version="4.0" scope="dev" />
          <package name="@types/bun" version="latest" scope="dev" />
          <package name="typescript" version="^5" scope="peer" />
          <package name="@biomejs/biome" version="2.3.2" scope="dev" />
        </current>
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Vitest configuration must match architecture.md template exactly (lines 1056-1070)</constraint>
    <constraint>Must use v8 coverage provider (not Istanbul or other providers)</constraint>
    <constraint>Coverage reporters must include text, json, and html formats</constraint>
    <constraint>Test environment must be 'node' for backend/utility testing</constraint>
    <constraint>Must enable globals for describe, test, expect functions</constraint>
    <constraint>Existing test files (package.test.ts, biome.config.test.ts) must continue working without modifications</constraint>
    <constraint>Existing package.json scripts ("test", "test:coverage") must work with new configuration</constraint>
    <constraint>Configuration should support TypeScript strict mode</constraint>
    <constraint>Should align with 70%+ coverage target from NFR-4</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>vitest.config.ts schema</name>
      <kind>configuration</kind>
      <signature>
import { defineConfig } from 'vitest/config'

export default defineConfig({
  test: {
    globals: true,
    environment: 'node',
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
    },
  },
})
      </signature>
      <path>vitest.config.ts</path>
    </interface>
    <interface>
      <name>package.json test scripts (already exist)</name>
      <kind>configuration</kind>
      <signature>
{
  "scripts": {
    "test": "bun test",
    "test:coverage": "bun test --coverage"
  }
}
      </signature>
      <path>package.json</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing framework is Vitest 4.0. This story configures Vitest itself, so tests should verify the configuration works correctly. Follow the comprehensive testing pattern established in Story 1.2 (biome.config.test.ts with 19 tests). Tests should verify vitest.config.ts exists, has correct structure, all settings are properly configured, and commands execute successfully. Use describe blocks for organization, proper test naming, and deterministic tests.
    </standards>
    <locations>
      <location>vitest.config.test.ts (comprehensive config testing)</location>
      <location>*.test.ts (co-located with source - established pattern)</location>
      <location>tests/integration/ (for future integration tests)</location>
    </locations>
    <ideas>
      <idea ac="1">Verify vitest.config.ts file exists and is valid TypeScript</idea>
      <idea ac="1">Parse vitest.config.ts and verify exports default defineConfig</idea>
      <idea ac="2">Verify test.environment is set to 'node'</idea>
      <idea ac="3">Verify test.coverage.provider is set to 'v8'</idea>
      <idea ac="4">Verify test.coverage.reporter includes text, json, html</idea>
      <idea ac="1,2,3,4">Verify test.globals is set to true</idea>
      <idea ac="5">Execute `bun test` and verify it runs vitest successfully</idea>
      <idea ac="6">Execute `bun test --coverage` and verify coverage reports generated</idea>
      <idea ac="6">Verify coverage directory created with text, json, html reports</idea>
      <idea ac="5,6">Verify existing tests (package.test.ts, biome.config.test.ts) still pass</idea>
    </ideas>
  </tests>
</story-context>
